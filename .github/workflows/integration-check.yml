name: Integration Check

on:
  push:
    branches: [ main, develop, copilot/** ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  integration-check:
    name: Frontend & Backend Integration Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'university-lms-frontend/package-lock.json'
      
      - name: Install Python dependencies
        run: |
          cd university_lms_backend
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Install Node.js dependencies
        run: |
          cd university-lms-frontend
          npm ci
      
      - name: Run Integration Check
        run: |
          python3 integration_check.py
      
      - name: Upload Integration Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-check-report
          path: integration_check_report.json
          retention-days: 30
      
      - name: Check Integration Health Score
        run: |
          python3 -c "
          import json
          import sys
          
          with open('integration_check_report.json') as f:
              data = json.load(f)
              summary = data['summary']
              total = summary['passed'] + summary['warnings'] + summary['failed']
              health = (summary['passed'] + summary['warnings'] * 0.5) / total * 100 if total > 0 else 0
              
              print(f'Integration Health Score: {health:.1f}%')
              print(f'Passed: {summary[\"passed\"]}')
              print(f'Warnings: {summary[\"warnings\"]}')
              print(f'Failed: {summary[\"failed\"]}')
              
              # Fail if health score is too low
              if health < 75:
                  print('❌ Health score below 75% threshold')
                  sys.exit(1)
              elif summary['failed'] > 3:
                  print('⚠️  Too many failed checks')
                  sys.exit(1)
              else:
                  print('✅ Integration check passed')
          "
      
      - name: Comment PR with Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = JSON.parse(fs.readFileSync('integration_check_report.json', 'utf8'));
            const summary = report.summary;
            const total = summary.passed + summary.warnings + summary.failed;
            const health = total > 0 ? ((summary.passed + summary.warnings * 0.5) / total * 100) : 0;
            
            let status = '✅ PASS';
            if (health < 75) {
              status = '❌ FAIL';
            } else if (summary.failed > 0) {
              status = '⚠️ WARNING';
            }
            
            const body = `## Integration Check Results ${status}
            
            **Health Score:** ${health.toFixed(1)}%
            
            | Status | Count |
            |--------|-------|
            | ✅ Passed | ${summary.passed} |
            | ⚠️ Warnings | ${summary.warnings} |
            | ❌ Failed | ${summary.failed} |
            
            <details>
            <summary>View detailed checks</summary>
            
            ${Object.entries(report.checks).map(([name, check]) => {
              const icon = check.status === 'PASS' ? '✅' : check.status === 'WARN' ? '⚠️' : '❌';
              return `- ${icon} **${name}**: ${check.status}${check.message ? ` - ${check.message}` : ''}`;
            }).join('\n')}
            
            </details>
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
